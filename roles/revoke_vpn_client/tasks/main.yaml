---
- name: Ensure required variables are defined
  fail: msg="{{ item }} value missing and is required"
  when: "item is not defined"
  with_items:
    - client_name
    - pki_password
    - ovpn_data

# not idempotant :(
- name: revoke easy rsa certificate
  shell: |
    docker run \
    -e PKI_PASS='{{ pki_password }}' \
    -v {{ ovpn_data }}:/etc/openvpn \
    --rm kylemanna/openvpn \
    /etc/openvpn/with_yes.sh easyrsa revoke {{ client_name }}
  no_log: true

# - name: remove ovpn config and keys
#   file:
#     path: "{{ item }}"
#     state: absent
#   with_items:
#     - "{{ ovpn_data }}client_confs/{{ client_name }}.ovpn"
#     - "{{ ovpn_data }}pki/private/{{ client_name }}.key"
#     - "{{ ovpn_data }}pki/issued/{{ client_name }}.crt"
